(function() {
  var Client, EventEmitter, Observable, Promise, identity, isString, ref,
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  ref = require("lodash"), isString = ref.isString, identity = ref.identity;

  EventEmitter = require("events");

  Promise = require("bluebird");

  Observable = require("zen-observable");

  Client = (function(superClass) {
    extend(Client, superClass);

    function Client(transport) {
      this.transport = transport;
      this.connection = null;
      this.heartbeat = "10000,0";
      this.receipts = {};
      this.subscriptions = {};
      this.receipt = 0;
      this.subscription = 0;
      this.disconnected = false;
      this.transport.on("frame", (function(_this) {
        return function(frame) {
          return _this.onFrame(frame);
        };
      })(this));
      this.transport.on("close", (function(_this) {
        return function() {
          return _this.emit("disconnected");
        };
      })(this));
    }

    Client.prototype.connect = function(headers) {
      var connected;
      if (!headers) {
        throw new Error("headers required");
      }
      if (!headers["accept-version"]) {
        throw new Error("accept-version header required");
      }
      if (!headers["host"]) {
        throw new Error("host header required");
      }
      if (headers["heart-beat"]) {
        this.heartbeat = headers["heart-beat"];
      } else {
        headers["heart-beat"] = this.heartbeat;
      }
      connected = new Promise((function(_this) {
        return function(resolve, reject) {
          return _this.connection = {
            resolve: resolve,
            reject: reject
          };
        };
      })(this))["finally"]((function(_this) {
        return function() {
          return _this.connection = null;
        };
      })(this));
      return this.sendFrame({
        command: "CONNECT",
        headers: headers
      }).tap((function(_this) {
        return function() {
          return connected;
        };
      })(this)).tap((function(_this) {
        return function() {
          return _this.emit("connected");
        };
      })(this));
    };

    Client.prototype.send = function(headers, body) {
      if (!headers) {
        throw new Error("headers required");
      }
      if (!headers["destination"]) {
        throw new Error("destination header required");
      }
      if (!isString(body)) {
        headers["content-type"] = "application/json";
        body = JSON.stringify(body);
      }
      if (!headers["receipt"]) {
        headers["receipt"] = "req-" + (this.receipt += 1);
      }
      return this.sendFrameWithReceipt({
        command: "SEND",
        headers: headers,
        body: body
      });
    };

    Client.prototype.source = function(headers) {
      return new Observable((function(_this) {
        return function(emitter) {
          _this.subscriptions[headers["id"]] = emitter;
          _this.subscribe(headers);
          return function() {
            return _this.unsubscribe(headers);
          };
        };
      })(this));
    };

    Client.prototype.subscribe = function(headers) {
      if (!headers) {
        throw new Error("headers required");
      }
      if (!headers["destination"]) {
        throw new Error("destination header required");
      }
      if (!headers["id"]) {
        headers["id"] = "S" + (this.subscription += 1);
      }
      return this.sendFrameWithReceipt({
        command: "SUBSCRIBE",
        headers: headers
      });
    };

    Client.prototype.unsubscribe = function(headers) {
      if (!headers) {
        throw new Error("headers required");
      }
      if (!headers["id"]) {
        throw new Error("id header required");
      }
      return this.sendFrameWithReceipt({
        command: "UNSUBSCRIBE",
        headers: headers
      }).tap((function(_this) {
        return function() {
          var id;
          id = headers["id"];
          if (_this.subscriptions[id]) {
            return delete _this.subscriptions[id];
          }
        };
      })(this));
    };

    Client.prototype.disconnect = function(headers) {
      var receipt;
      receipt = this.sendFrameWithReceipt({
        command: "DISCONNECT",
        headers: headers || {}
      });
      this.disconnected = true;
      return receipt["finally"]((function(_this) {
        return function() {
          return _this.transport.close();
        };
      })(this));
    };

    Client.prototype.onFrame = function(frame) {
      var body, command, headers;
      command = frame.command, headers = frame.headers, body = frame.body;
      switch (command) {
        case "CONNECTED":
          return this.onConnected(headers);
        case "RECEIPT":
          return this.onReceipt(headers);
        case "ERROR":
          return this.onError(headers);
        case "MESSAGE":
          return this.onMessage(headers, body);
      }
    };

    Client.prototype.onConnected = function(headers) {
      var heartbeat;
      if (heartbeat = headers["heart-beat"]) {
        this.autoHeartbeat(heartbeat);
      }
      if (this.connection) {
        return this.connection.resolve();
      }
    };

    Client.prototype.onReceipt = function(headers) {
      var receipt;
      if (receipt = this.receipts[headers["receipt-id"]]) {
        return receipt.resolve();
      }
    };

    Client.prototype.onError = function(headers) {
      var err, receipt;
      err = new Error(headers["message"]);
      if (this.connection) {
        this.connection.reject(err);
      }
      if (receipt = this.receipts[headers["receipt-id"]]) {
        return receipt.reject(err);
      }
    };

    Client.prototype.onMessage = function(headers, body) {
      var subscription;
      if (subscription = this.subscriptions[headers["subscription"]]) {
        return subscription.next(body);
      }
    };

    Client.prototype.sendFrameWithReceipt = function(frame) {
      var receipt, received;
      receipt = "R" + (this.receipt += 1);
      frame.headers["receipt"] = receipt;
      received = new Promise((function(_this) {
        return function(resolve, reject) {
          return _this.receipts[receipt] = {
            resolve: resolve,
            reject: reject
          };
        };
      })(this))["finally"]((function(_this) {
        return function() {
          return delete _this.receipts[receipt];
        };
      })(this));
      return this.sendFrame(frame).tap((function(_this) {
        return function() {
          return received;
        };
      })(this));
    };

    Client.prototype.sendFrame = function(frame) {
      if (this.disconnected) {
        return Promise.reject(new Error("client disconnected"));
      } else {
        return this.transport.sendFrame(frame);
      }
    };

    Client.prototype.autoHeartbeat = function(header) {
      var cx, cy, frequency, ref1, ref2, sx, sy;
      ref1 = this.heartbeat.split(",").map(Number), cx = ref1[0], cy = ref1[1];
      ref2 = header.split(",").map(Number), sx = ref2[0], sy = ref2[1];
      if (cx > 0 && sy > 0) {
        frequency = Math.max(cx, sy);
        return this.transport.autoHeartbeat(frequency);
      }
    };

    return Client;

  })(EventEmitter);

  module.exports = Client;

}).call(this);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNsaWVudC9jbGllbnQuY29mZmVlIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQUEsTUFBQSxrRUFBQTtJQUFBOzs7RUFBQSxNQUF1QixPQUFBLENBQVEsUUFBUixDQUF2QixFQUFDLGVBQUEsUUFBRCxFQUFXLGVBQUE7O0VBQ1gsWUFBQSxHQUFlLE9BQUEsQ0FBUSxRQUFSOztFQUNmLE9BQUEsR0FBVSxPQUFBLENBQVEsVUFBUjs7RUFDVixVQUFBLEdBQWEsT0FBQSxDQUFRLGdCQUFSOztFQUVQOzs7SUFDUyxnQkFBQyxTQUFEO01BQ1gsSUFBQyxDQUFBLFNBQUQsR0FBYTtNQUdiLElBQUMsQ0FBQSxVQUFELEdBQWM7TUFDZCxJQUFDLENBQUEsU0FBRCxHQUFhO01BR2IsSUFBQyxDQUFBLFFBQUQsR0FBWTtNQUdaLElBQUMsQ0FBQSxhQUFELEdBQWlCO01BR2pCLElBQUMsQ0FBQSxPQUFELEdBQVc7TUFDWCxJQUFDLENBQUEsWUFBRCxHQUFnQjtNQUdoQixJQUFDLENBQUEsWUFBRCxHQUFnQjtNQUVoQixJQUFDLENBQUEsU0FBUyxDQUFDLEVBQVgsQ0FBYyxPQUFkLEVBQXVCLENBQUEsU0FBQSxLQUFBO2VBQUEsU0FBQyxLQUFEO2lCQUNyQixLQUFDLENBQUEsT0FBRCxDQUFTLEtBQVQ7UUFEcUI7TUFBQSxDQUFBLENBQUEsQ0FBQSxJQUFBLENBQXZCO01BR0EsSUFBQyxDQUFBLFNBQVMsQ0FBQyxFQUFYLENBQWMsT0FBZCxFQUF1QixDQUFBLFNBQUEsS0FBQTtlQUFBLFNBQUE7aUJBQ3JCLEtBQUMsQ0FBQSxJQUFELENBQU0sY0FBTjtRQURxQjtNQUFBLENBQUEsQ0FBQSxDQUFBLElBQUEsQ0FBdkI7SUF2Qlc7O3FCQTBCYixPQUFBLEdBQVMsU0FBQyxPQUFEO0FBQ1AsVUFBQTtNQUFBLElBQUEsQ0FBTyxPQUFQO0FBQ0UsY0FBVSxJQUFBLEtBQUEsQ0FBTSxrQkFBTixFQURaOztNQUVBLElBQUEsQ0FBTyxPQUFRLENBQUEsZ0JBQUEsQ0FB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QUExQixDQUFiLEVBQUUsWUFBRixFQUFNO01BQ04sT0FBYSxNQUFNLENBQUMsS0FBUCxDQUFhLEdBQWIsQ0FBaUIsQ0FBQyxHQUFsQixDQUFzQixNQUF0QixDQUFiLEVBQUUsWUFBRixFQUFNO01BQ04sSUFBRyxFQUFBLEdBQUssQ0FBTCxJQUFVLEVBQUEsR0FBSyxDQUFsQjtRQUNFLFNBQUEsR0FBWSxJQUFJLENBQUMsR0FBTCxDQUFTLEVBQVQsRUFBYSxFQUFiO2VBQ1osSUFBQyxDQUFBLFNBQVMsQ0FBQyxhQUFYLENBQXlCLFNBQXpCLEVBRkY7O0lBSGE7Ozs7S0F4S0k7O0VBK0tyQixNQUFNLENBQUMsT0FBUCxHQUFpQjtBQXBMakIiLCJmaWxlIjoiY2xpZW50L2NsaWVudC5qcyIsInNvdXJjZVJvb3QiOiIvc291cmNlLyIsInNvdXJjZXNDb250ZW50IjpbIntpc1N0cmluZywgaWRlbnRpdHl9ID0gcmVxdWlyZSBcImxvZGFzaFwiXG5FdmVudEVtaXR0ZXIgPSByZXF1aXJlIFwiZXZlbnRzXCJcblByb21pc2UgPSByZXF1aXJlIFwiYmx1ZWJpcmRcIlxuT2JzZXJ2YWJsZSA9IHJlcXVpcmUgXCJ6ZW4tb2JzZXJ2YWJsZVwiXG5cbmNsYXNzIENsaWVudCBleHRlbmRzIEV2ZW50RW1pdHRlclxuICBjb25zdHJ1Y3RvcjogKHRyYW5zcG9ydCkgLT5cbiAgICBAdHJhbnNwb3J0ID0gdHJhbnNwb3J0XG4gICAgXG4gICAgIyBkZWZhdWx0IHRvID49IDEwIHNlY29uZHNcbiAgICBAY29ubmVjdGlvbiA9IG51bGxcbiAgICBAaGVhcnRiZWF0ID0gXCIxMDAwMCwwXCJcbiAgICBcbiAgICAjIHByb21pc2UgaGFuZGxlcnNcbiAgICBAcmVjZWlwdHMgPSB7fVxuICAgIFxuICAgICMgb2JzZXJ2YWJsZSBoYW5kbGVyc1xuICAgIEBzdWJzY3JpcHRpb25zID0ge31cbiAgICBcbiAgICAjIHVuaXF1ZSBpZCBjb3VudGVyc1xuICAgIEByZWNlaXB0ID0gMFxuICAgIEBzdWJzY3JpcHRpb24gPSAwXG4gICAgXG4gICAgIyBmbGFnIHdoZW4gZGVhZFxuICAgIEBkaXNjb25uZWN0ZWQgPSBmYWxzZVxuICAgIFxuICAgIEB0cmFuc3BvcnQub24gXCJmcmFtZVwiLCAoZnJhbWUpID0+XG4gICAgICBAb25GcmFtZSBmcmFtZVxuICAgIFxuICAgIEB0cmFuc3BvcnQub24gXCJjbG9zZVwiLCA9PlxuICAgICAgQGVtaXQgXCJkaXNjb25uZWN0ZWRcIlxuXG4gIGNvbm5lY3Q6IChoZWFkZXJzKSAtPlxuICAgIHVubGVzcyBoZWFkZXJzXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJoZWFkZXJzIHJlcXVpcmVkXCIpXG4gICAgdW5sZXNzIGhlYWRlcnNbXCJhY2NlcHQtdmVyc2lvblwiXVxuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiYWNjZXB0LXZlcnNpb24gaGVhZGVyIHJlcXVpcmVkXCIpXG4gICAgdW5sZXNzIGhlYWRlcnNbXCJob3N0XCJdXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJob3N0IGhlYWRlciByZXF1aXJlZFwiKVxuICAgIFxuICAgIGlmIGhlYWRlcnNbXCJoZWFydC1iZWF0XCJdXG4gICAgICBAaGVhcnRiZWF0ID0gaGVhZGVyc1tcImhlYXJ0LWJlYXRcIl1cbiAgICBlbHNlXG4gICAgICBoZWFkZXJzW1wiaGVhcnQtYmVhdFwiXSA9IEBoZWFydGJlYXRcbiAgICBcbiAgICBjb25uZWN0ZWQgPSBuZXcgUHJvbWlzZSAocmVzb2x2ZSwgcmVqZWN0KSA9PlxuICAgICAgQGNvbm5lY3Rpb24gPSB7cmVzb2x2ZSwgcmVqZWN0fVxuICAgIC5maW5hbGx5ID0+XG4gICAgICBAY29ubmVjdGlvbiA9IG51bGxcbiAgICBcbiAgICBAc2VuZEZyYW1lXG4gICAgICBjb21tYW5kOiBcIkNPTk5FQ1RcIlxuICAgICAgaGVhZGVyczogaGVhZGVyc1xuICAgIC50YXAgPT5cbiAgICAgIGNvbm5lY3RlZFxuICAgIC50YXAgPT5cbiAgICAgIEBlbWl0IFwiY29ubmVjdGVkXCJcblxuICBzZW5kOiAoaGVhZGVycywgYm9keSkgLT5cbiAgICB1bmxlc3MgaGVhZGVyc1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiaGVhZGVycyByZXF1aXJlZFwiKVxuICAgIHVubGVzcyBoZWFkZXJzW1wiZGVzdGluYXRpb25cIl1cbiAgICAgIHRocm93IG5ldyBFcnJvcihcImRlc3RpbmF0aW9uIGhlYWRlciByZXF1aXJlZFwiKVxuICAgIFxuICAgIHVubGVzcyBpc1N0cmluZyhib2R5KVxuICAgICAgaGVhZGVyc1tcImNvbnRlbnQtdHlwZVwiXSA9IFwiYXBwbGljYXRpb24vanNvblwiXG4gICAgICBib2R5ID0gSlNPTi5zdHJpbmdpZnkoYm9keSlcbiAgICBcbiAgICB1bmxlc3MgaGVhZGVyc1tcInJlY2VpcHRcIl1cbiAgICAgIGhlYWRlcnNbXCJyZWNlaXB0XCJdID0gXCJyZXEtI3sgQHJlY2VpcHQgKz0gMSB9XCJcbiAgICBcbiAgICBAc2VuZEZyYW1lV2l0aFJlY2VpcHRcbiAgICAgIGNvbW1hbmQ6IFwiU0VORFwiXG4gICAgICBoZWFkZXJzOiBoZWFkZXJzXG4gICAgICBib2R5OiBib2R5XG5cbiAgc291cmNlOiAoaGVhZGVycykgLT5cbiAgICBuZXcgT2JzZXJ2YWJsZSAoZW1pdHRlcikgPT4gICAgICBcbiAgICAgIEBzdWJzY3JpcHRpb25zWyBoZWFkZXJzW1wiaWRcIl0gXSA9IGVtaXR0ZXJcbiAgICAgIEBzdWJzY3JpYmUgaGVhZGVyc1xuICAgICAgPT5cbiAgICAgICAgQHVuc3Vic2NyaWJlIGhlYWRlcnNcblxuICBzdWJzY3JpYmU6IChoZWFkZXJzKSAtPlxuICAgIHVubGVzcyBoZWFkZXJzXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJoZWFkZXJzIHJlcXVpcmVkXCIpXG4gICAgdW5sZXNzIGhlYWRlcnNbXCJkZXN0aW5hdGlvblwiXVxuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiZGVzdGluYXRpb24gaGVhZGVyIHJlcXVpcmVkXCIpXG4gICAgXG4gICAgdW5sZXNzIGhlYWRlcnNbXCJpZFwiXVxuICAgICAgaGVhZGVyc1tcImlkXCJdID0gXCJTI3sgQHN1YnNjcmlwdGlvbiArPSAxIH1cIlxuICAgIFxuICAgIEBzZW5kRnJhbWVXaXRoUmVjZWlwdFxuICAgICAgY29tbWFuZDogXCJTVUJTQ1JJQkVcIlxuICAgICAgaGVhZGVyczogaGVhZGVyc1xuXG4gIHVuc3Vic2NyaWJlOiAoaGVhZGVycykgLT5cbiAgICB1bmxlc3MgaGVhZGVyc1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiaGVhZGVycyByZXF1aXJlZFwiKVxuICAgIHVubGVzcyBoZWFkZXJzW1wiaWRcIl1cbiAgICAgIHRocm93IG5ldyBFcnJvcihcImlkIGhlYWRlciByZXF1aXJlZFwiKVxuXG4gICAgQHNlbmRGcmFtZVdpdGhSZWNlaXB0XG4gICAgICBjb21tYW5kOiBcIlVOU1VCU0NSSUJFXCJcbiAgICAgIGhlYWRlcnM6IGhlYWRlcnNcbiAgICAudGFwID0+XG4gICAgICBpZCA9IGhlYWRlcnNbXCJpZFwiXVxuICAgICAgaWYgQHN1YnNjcmlwdGlvbnNbaWRdXG4gICAgICAgIGRlbGV0ZSBAc3Vic2NyaXB0aW9uc1tpZF1cblxuICBkaXNjb25uZWN0OiAoaGVhZGVycykgLT5cbiAgICByZWNlaXB0ID0gQHNlbmRGcmFtZVdpdGhSZWNlaXB0XG4gICAgICBjb21tYW5kOiBcIkRJU0NPTk5FQ1RcIlxuICAgICAgaGVhZGVyczogaGVhZGVycyB8fCB7fVxuICAgIEBkaXNjb25uZWN0ZWQgPSB0cnVlXG4gICAgcmVjZWlwdC5maW5hbGx5ID0+XG4gICAgICBAdHJhbnNwb3J0LmNsb3NlKClcblxuICAjIC0tLVxuXG4gIG9uRnJhbWU6IChmcmFtZSkgLT5cbiAgICB7Y29tbWFuZCwgaGVhZGVycywgYm9keX0gPSBmcmFtZVxuICAgIHN3aXRjaCBjb21tYW5kXG4gICAgICB3aGVuIFwiQ09OTkVDVEVEXCJcbiAgICAgICAgQG9uQ29ubmVjdGVkIGhlYWRlcnNcbiAgICAgIHdoZW4gXCJSRUNFSVBUXCJcbiAgICAgICAgQG9uUmVjZWlwdCBoZWFkZXJzXG4gICAgICB3aGVuIFwiRVJST1JcIlxuICAgICAgICBAb25FcnJvciBoZWFkZXJzXG4gICAgICB3aGVuIFwiTUVTU0FHRVwiXG4gICAgICAgIEBvbk1lc3NhZ2UgaGVhZGVycywgYm9keVxuXG4gIG9uQ29ubmVjdGVkOiAoaGVhZGVycykgLT5cbiAgICBpZiBoZWFydGJlYXQgPSBoZWFkZXJzW1wiaGVhcnQtYmVhdFwiXVxuICAgICAgQGF1dG9IZWFydGJlYXQgaGVhcnRiZWF0XG4gICAgaWYgQGNvbm5lY3Rpb25cbiAgICAgIEBjb25uZWN0aW9uLnJlc29sdmUoKVxuXG4gIG9uUmVjZWlwdDogKGhlYWRlcnMpIC0+XG4gICAgaWYgcmVjZWlwdCA9IEByZWNlaXB0c1toZWFkZXJzW1wicmVjZWlwdC1pZFwiXV1cbiAgICAgIHJlY2VpcHQucmVzb2x2ZSgpXG5cbiAgb25FcnJvcjogKGhlYWRlcnMpIC0+XG4gICAgZXJyID0gbmV3IEVycm9yKGhlYWRlcnNbXCJtZXNzYWdlXCJdKVxuICAgIGlmIEBjb25uZWN0aW9uXG4gICAgICBAY29ubmVjdGlvbi5yZWplY3QgZXJyXG4gICAgaWYgcmVjZWlwdCA9IEByZWNlaXB0c1toZWFkZXJzW1wicmVjZWlwdC1pZFwiXV1cbiAgICAgIHJlY2VpcHQucmVqZWN0IGVyclxuXG4gIG9uTWVzc2FnZTogKGhlYWRlcnMsIGJvZHkpIC0+XG4gICAgaWYgc3Vic2NyaXB0aW9uID0gQHN1YnNjcmlwdGlvbnNbaGVhZGVyc1tcInN1YnNjcmlwdGlvblwiXV1cbiAgICAgIHN1YnNjcmlwdGlvbi5uZXh0IGJvZHlcblxuICAjIC0tLVxuXG4gIHNlbmRGcmFtZVdpdGhSZWNlaXB0OiAoZnJhbWUpIC0+XG4gICAgcmVjZWlwdCA9IFwiUiN7IEByZWNlaXB0ICs9IDEgfVwiXG4gICAgZnJhbWUuaGVhZGVyc1tcInJlY2VpcHRcIl0gPSByZWNlaXB0XG4gICAgXG4gICAgcmVjZWl2ZWQgPSBuZXcgUHJvbWlzZSAocmVzb2x2ZSwgcmVqZWN0KSA9PlxuICAgICAgQHJlY2VpcHRzW3JlY2VpcHRdID0ge3Jlc29sdmUsIHJlamVjdH1cbiAgICAuZmluYWxseSA9PlxuICAgICAgZGVsZXRlIEByZWNlaXB0c1tyZWNlaXB0XVxuICAgIFxuICAgIEBzZW5kRnJhbWUgZnJhbWVcbiAgICAgIC50YXAgPT4gcmVjZWl2ZWRcblxuICBzZW5kRnJhbWU6IChmcmFtZSkgLT5cbiAgICBpZiBAZGlzY29ubmVjdGVkXG4gICAgICBQcm9taXNlLnJlamVjdCBuZXcgRXJyb3IoXCJjbGllbnQgZGlzY29ubmVjdGVkXCIpXG4gICAgZWxzZVxuICAgICAgQHRyYW5zcG9ydC5zZW5kRnJhbWUgZnJhbWVcblxuICBhdXRvSGVhcnRiZWF0OiAoaGVhZGVyKSAtPlxuICAgIFsgY3gsIGN5IF0gPSBAaGVhcnRiZWF0LnNwbGl0KFwiLFwiKS5tYXAgTnVtYmVyXG4gICAgWyBzeCwgc3kgXSA9IGhlYWRlci5zcGxpdChcIixcIikubWFwIE51bWJlclxuICAgIGlmIGN4ID4gMCAmJiBzeSA+IDBcbiAgICAgIGZyZXF1ZW5jeSA9IE1hdGgubWF4IGN4LCBzeVxuICAgICAgQHRyYW5zcG9ydC5hdXRvSGVhcnRiZWF0IGZyZXF1ZW5jeVxuXG5tb2R1bGUuZXhwb3J0cyA9IENsaWVudFxuIl19
