(function() {
  var EventEmitter, Transport, assert;

  assert = require("assert");

  Transport = require("./transport");

  EventEmitter = require("events");

  describe("Transport", function() {
    beforeEach(function() {
      this.ws = new EventEmitter();
      return this.transport = new Transport(this.ws);
    });
    describe("events", function() {
      it("should propagate open event", function(done) {
        this.transport.on("open", function() {
          return done();
        });
        return this.ws.emit("open");
      });
      it("should propagate error event", function(done) {
        this.transport.on("error", function(err) {
          assert.equal(err.message, "ok");
          return done();
        });
        return this.ws.emit("error", new Error("ok"));
      });
      return it("should propagate close event", function(done) {
        this.transport.on("close", function() {
          return done();
        });
        return this.ws.emit("close");
      });
    });
    describe("messages", function() {
      it("should emit heartbeats", function(done) {
        this.transport.on("heartbeat", function() {
          return done();
        });
        return this.ws.emit("message", "\n");
      });
      return it("should emit frames", function(done) {
        this.transport.on("frame", function(frame) {
          assert.equal(frame.command, "CONNECTED");
          return done();
        });
        return this.ws.emit("message", "CONNECTED\n\0");
      });
    });
    describe("close", function() {
      return it("should close the websocket", function(done) {
        this.ws.close = function() {
          return done();
        };
        return this.transport.close();
      });
    });
    describe("send frame", function() {
      it("should encode frames", function() {
        this.ws.send = function(message, fn) {
          assert.equal(message, "CONNECT\naccept-version:1.2\n\n\0");
          return fn(null);
        };
        return this.transport.sendFrame({
          command: "CONNECT",
          headers: {
            "accept-version": "1.2"
          }
        });
      });
      return it("should fail on error", function() {
        var onError, onSuccess;
        this.ws.send = function(message, fn) {
          return fn(new Error("websocket closed"));
        };
        onSuccess = function() {
          throw new Error("invalid code path");
        };
        onError = function(err) {
          return assert.equal(err.message, "websocket closed");
        };
        return this.transport.sendFrame({
          command: "CONNECTED"
        }).then(onSuccess, onError);
      });
    });
    describe("send heartbeat", function() {
      it("should send empty message", function() {
        this.ws.send = function(message, fn) {
          assert.equal(message, "\n");
          return fn();
        };
        return this.transport.sendHeartbeat();
      });
      return it("should fail on error", function() {
        var onError, onSuccess;
        this.ws.send = function(message, fn) {
          return fn(new Error("ok"));
        };
        onSuccess = function() {
          throw new Error("invalid code path");
        };
        onError = function(err) {
          return assert.equal(err.message, "ok");
        };
        return this.transport.sendHeartbeat().then(onSuccess, onError);
      });
    });
    return describe("auto heartbeat", function() {
      return it("should start timer", function(done) {
        var intid, onTimeout, outbox;
        outbox = [];
        this.ws.send = function(message, fn) {
          outbox.push(message);
          return fn();
        };
        intid = this.transport.autoHeartbeat(5);
        onTimeout = function() {
          clearInterval(intid);
          assert.equal(outbox.length, 2);
          return done();
        };
        return setTimeout(onTimeout, 14);
      });
    });
  });

}).call(this);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRyYW5zcG9ydC90cmFuc3BvcnQtdGVzdC5jb2ZmZWUiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7QUFBQSxNQUFBOztFQUFBLE1BQUEsR0FBUyxPQUFBLENBQVEsUUFBUjs7RUFDVCxTQUFBLEdBQVksT0FBQSxDQUFRLGFBQVI7O0VBQ1osWUFBQSxHQUFlLE9BQUEsQ0FBUSxRQUFSOztFQUVmLFFBQUEsQ0FBUyxXQUFULEVBQXNCLFNBQUE7SUFDcEIsVUFBQSxDQUFXLFNBQUE7TUFDVCxJQUFDLENBQUEsRUFBRCxHQUFVLElBQUEsWUFBQSxDQUFBO2FBQ1YsSUFBQyxDQUFBLFNBQUQsR0FBaUIsSUFBQSxTQUFBLENBQVUsSUFBQyxDQUFBLEVBQVg7SUFGUixDQUFYO0lBSUEsUUFBQSxDQUFTLFFBQVQsRUFBbUIsU0FBQTtNQUNqQixFQUFBLENBQUcsNkJBQUgsRUFBa0MsU0FBQyxJQUFEO1FBQ2hDLElBQUMsQ0FBQSxTQUFTLENBQUMsRUFBWCxDQUFjLE1BQWQsRUFBc0IsU0FBQTtpQkFDcEIsSUFBQSxDQUFBO1FBRG9CLENBQXRCO2VBRUEsSUFBQyxDQUFBLEVBQUUsQ0FBQyxJQUFKLENBQVMsTUFBVDtNQUhnQyxDQUFsQztNQUtBLEVBQUEsQ0FBRyw4QkFBSCxFQUFtQyxTQUFDLElBQUQ7UUFDakMsSUFBQyxDQUFBLFNBQVMsQ0FBQyxFQUFYLENBQWMsT0FBZCxFQUF1QixTQUFDLEdBQUQ7VUFDckIsTUFBTSxDQUFDLEtBQVAsQ0FBYSxHQUFHLENBQUMsT0FBakIsRUFBMEIsSUFBMUI7aUJBQ0EsSUFBQSxDQUFBO1FBRnFCLENBQXZCO2VBR0EsSUFBQyxDQUFBLEVBQUUsQ0FBQyxJQUFKLENBQVMsT0FBVCxFQUFzQixJQUFBLEtBQUEsQ0FBTSxJQUFOLENBQXRCO01BSmlDLENBQW5DO2FBTUEsRUFBQSxDQUFHLDhCQUFILEVBQW1DLFNBQUMsSUFBRDtRQUNqQyxJQUFDLENBQUEsU0FBUyxDQUFDLEVBQVgsQ0FBYyxPQUFkLEVBQXVCLFNBQUE7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RUFBQSxDQUFPLElBQUEsS0FBQSxDQUFNLElBQU4sQ0FBUDtRQURTO1FBR1gsU0FBQSxHQUFZLFNBQUE7QUFDVixnQkFBVSxJQUFBLEtBQUEsQ0FBTSxtQkFBTjtRQURBO1FBR1osT0FBQSxHQUFVLFNBQUMsR0FBRDtpQkFDUixNQUFNLENBQUMsS0FBUCxDQUFhLEdBQUcsQ0FBQyxPQUFqQixFQUEwQixJQUExQjtRQURRO2VBR1YsSUFBQyxDQUFBLFNBQVMsQ0FBQyxhQUFYLENBQUEsQ0FDRSxDQUFDLElBREgsQ0FDUSxTQURSLEVBQ21CLE9BRG5CO01BVnlCLENBQTNCO0lBUHlCLENBQTNCO1dBb0JBLFFBQUEsQ0FBUyxnQkFBVCxFQUEyQixTQUFBO2FBQ3pCLEVBQUEsQ0FBRyxvQkFBSCxFQUF5QixTQUFDLElBQUQ7QUFDdkIsWUFBQTtRQUFBLE1BQUEsR0FBUztRQUNULElBQUMsQ0FBQSxFQUFFLENBQUMsSUFBSixHQUFXLFNBQUMsT0FBRCxFQUFVLEVBQVY7VUFDVCxNQUFNLENBQUMsSUFBUCxDQUFZLE9BQVo7aUJBQ0EsRUFBQSxDQUFBO1FBRlM7UUFHWCxLQUFBLEdBQVEsSUFBQyxDQUFBLFNBQVMsQ0FBQyxhQUFYLENBQXlCLENBQXpCO1FBQ1IsU0FBQSxHQUFZLFNBQUE7VUFDVixhQUFBLENBQWMsS0FBZDtVQUNBLE1BQU0sQ0FBQyxLQUFQLENBQWEsTUFBTSxDQUFDLE1BQXBCLEVBQTRCLENBQTVCO2lCQUNBLElBQUEsQ0FBQTtRQUhVO2VBSVosVUFBQSxDQUFXLFNBQVgsRUFBc0IsRUFBdEI7TUFWdUIsQ0FBekI7SUFEeUIsQ0FBM0I7RUFsRm9CLENBQXRCO0FBSkEiLCJmaWxlIjoidHJhbnNwb3J0L3RyYW5zcG9ydC10ZXN0LmpzIiwic291cmNlUm9vdCI6Ii9zb3VyY2UvIiwic291cmNlc0NvbnRlbnQiOlsiYXNzZXJ0ID0gcmVxdWlyZSBcImFzc2VydFwiXG5UcmFuc3BvcnQgPSByZXF1aXJlIFwiLi90cmFuc3BvcnRcIlxuRXZlbnRFbWl0dGVyID0gcmVxdWlyZSBcImV2ZW50c1wiXG5cbmRlc2NyaWJlIFwiVHJhbnNwb3J0XCIsIC0+XG4gIGJlZm9yZUVhY2ggLT5cbiAgICBAd3MgPSBuZXcgRXZlbnRFbWl0dGVyKClcbiAgICBAdHJhbnNwb3J0ID0gbmV3IFRyYW5zcG9ydChAd3MpXG4gIFxuICBkZXNjcmliZSBcImV2ZW50c1wiLCAtPlxuICAgIGl0IFwic2hvdWxkIHByb3BhZ2F0ZSBvcGVuIGV2ZW50XCIsIChkb25lKSAtPlxuICAgICAgQHRyYW5zcG9ydC5vbiBcIm9wZW5cIiwgLT5cbiAgICAgICAgZG9uZSgpXG4gICAgICBAd3MuZW1pdCBcIm9wZW5cIlxuICAgIFxuICAgIGl0IFwic2hvdWxkIHByb3BhZ2F0ZSBlcnJvciBldmVudFwiLCAoZG9uZSkgLT5cbiAgICAgIEB0cmFuc3BvcnQub24gXCJlcnJvclwiLCAoZXJyKSAtPlxuICAgICAgICBhc3NlcnQuZXF1YWwgZXJyLm1lc3NhZ2UsIFwib2tcIlxuICAgICAgICBkb25lKClcbiAgICAgIEB3cy5lbWl0IFwiZXJyb3JcIiwgbmV3IEVycm9yKFwib2tcIilcbiAgICBcbiAgICBpdCBcInNob3VsZCBwcm9wYWdhdGUgY2xvc2UgZXZlbnRcIiwgKGRvbmUpIC0+XG4gICAgICBAdHJhbnNwb3J0Lm9uIFwiY2xvc2VcIiwgLT5cbiAgICAgICAgZG9uZSgpXG4gICAgICBAd3MuZW1pdCBcImNsb3NlXCJcbiAgICBcbiAgZGVzY3JpYmUgXCJtZXNzYWdlc1wiLCAtPlxuICAgIGl0IFwic2hvdWxkIGVtaXQgaGVhcnRiZWF0c1wiLCAoZG9uZSkgLT5cbiAgICAgIEB0cmFuc3BvcnQub24gXCJoZWFydGJlYXRcIiwgLT5cbiAgICAgICAgZG9uZSgpXG4gICAgICBAd3MuZW1pdCBcIm1lc3NhZ2VcIiwgXCJcXG5cIlxuICAgIFxuICAgIGl0IFwic2hvdWxkIGVtaXQgZnJhbWVzXCIsIChkb25lKSAtPlxuICAgICAgQHRyYW5zcG9ydC5vbiBcImZyYW1lXCIsIChmcmFtZSkgLT5cbiAgICAgICAgYXNzZXJ0LmVxdWFsIGZyYW1lLmNvbW1hbmQsIFwiQ09OTkVDVEVEXCJcbiAgICAgICAgZG9uZSgpXG4gICAgICBAd3MuZW1pdCBcIm1lc3NhZ2VcIiwgXCJDT05ORUNURURcXG5cXDBcIlxuICBcbiAgZGVzY3JpYmUgXCJjbG9zZVwiLCAtPlxuICAgIGl0IFwic2hvdWxkIGNsb3NlIHRoZSB3ZWJzb2NrZXRcIiwgKGRvbmUpIC0+XG4gICAgICBAd3MuY2xvc2UgPSAtPlxuICAgICAgICBkb25lKClcbiAgICAgIEB0cmFuc3BvcnQuY2xvc2UoKVxuXG4gIGRlc2NyaWJlIFwic2VuZCBmcmFtZVwiLCAtPlxuICAgIGl0IFwic2hvdWxkIGVuY29kZSBmcmFtZXNcIiwgLT5cbiAgICAgIEB3cy5zZW5kID0gKG1lc3NhZ2UsIGZuKSAtPlxuICAgICAgICBhc3NlcnQuZXF1YWwgbWVzc2FnZSwgXCJDT05ORUNUXFxuYWNjZXB0LXZlcnNpb246MS4yXFxuXFxuXFwwXCJcbiAgICAgICAgZm4obnVsbClcbiAgICAgIEB0cmFuc3BvcnQuc2VuZEZyYW1lXG4gICAgICAgIGNvbW1hbmQ6IFwiQ09OTkVDVFwiXG4gICAgICAgIGhlYWRlcnM6IHsgXCJhY2NlcHQtdmVyc2lvblwiOiBcIjEuMlwiIH1cbiAgICBcbiAgICBpdCBcInNob3VsZCBmYWlsIG9uIGVycm9yXCIsIC0+XG4gICAgICBAd3Muc2VuZCA9IChtZXNzYWdlLCBmbikgLT5cbiAgICAgICAgZm4obmV3IEVycm9yKFwid2Vic29ja2V0IGNsb3NlZFwiKSlcbiAgICAgIFxuICAgICAgb25TdWNjZXNzID0gLT5cbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiaW52YWxpZCBjb2RlIHBhdGhcIilcbiAgICAgIFxuICAgICAgb25FcnJvciA9IChlcnIpIC0+XG4gICAgICAgIGFzc2VydC5lcXVhbCBlcnIubWVzc2FnZSwgXCJ3ZWJzb2NrZXQgY2xvc2VkXCJcbiAgICAgIFxuICAgICAgQHRyYW5zcG9ydC5zZW5kRnJhbWUoY29tbWFuZDogXCJDT05ORUNURURcIilcbiAgICAgICAgLnRoZW4ob25TdWNjZXNzLCBvbkVycm9yKVxuXG4gIGRlc2NyaWJlIFwic2VuZCBoZWFydGJlYXRcIiwgLT5cbiAgICBpdCBcInNob3VsZCBzZW5kIGVtcHR5IG1lc3NhZ2VcIiwgLT5cbiAgICAgIEB3cy5zZW5kID0gKG1lc3NhZ2UsIGZuKSAtPlxuICAgICAgICBhc3NlcnQuZXF1YWwgbWVzc2FnZSwgXCJcXG5cIlxuICAgICAgICBmbigpXG4gICAgICBAdHJhbnNwb3J0LnNlbmRIZWFydGJlYXQoKVxuICAgIFxuICAgIGl0IFwic2hvdWxkIGZhaWwgb24gZXJyb3JcIiwgLT5cbiAgICAgIEB3cy5zZW5kID0gKG1lc3NhZ2UsIGZuKSAtPlxuICAgICAgICBmbihuZXcgRXJyb3IoXCJva1wiKSlcbiAgICAgIFxuICAgICAgb25TdWNjZXNzID0gLT5cbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiaW52YWxpZCBjb2RlIHBhdGhcIilcbiAgICAgIFxuICAgICAgb25FcnJvciA9IChlcnIpIC0+XG4gICAgICAgIGFzc2VydC5lcXVhbCBlcnIubWVzc2FnZSwgXCJva1wiXG4gICAgICBcbiAgICAgIEB0cmFuc3BvcnQuc2VuZEhlYXJ0YmVhdCgpXG4gICAgICAgIC50aGVuKG9uU3VjY2Vzcywgb25FcnJvcilcblxuICBkZXNjcmliZSBcImF1dG8gaGVhcnRiZWF0XCIsIC0+XG4gICAgaXQgXCJzaG91bGQgc3RhcnQgdGltZXJcIiwgKGRvbmUpIC0+XG4gICAgICBvdXRib3ggPSBbXVxuICAgICAgQHdzLnNlbmQgPSAobWVzc2FnZSwgZm4pIC0+XG4gICAgICAgIG91dGJveC5wdXNoIG1lc3NhZ2VcbiAgICAgICAgZm4oKVxuICAgICAgaW50aWQgPSBAdHJhbnNwb3J0LmF1dG9IZWFydGJlYXQoNSlcbiAgICAgIG9uVGltZW91dCA9IC0+XG4gICAgICAgIGNsZWFySW50ZXJ2YWwgaW50aWRcbiAgICAgICAgYXNzZXJ0LmVxdWFsIG91dGJveC5sZW5ndGgsIDJcbiAgICAgICAgZG9uZSgpXG4gICAgICBzZXRUaW1lb3V0IG9uVGltZW91dCwgMTRcbiJdfQ==
